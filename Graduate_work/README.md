# Проект Клиенты и счета.
## Проект служит для построения витрины из набора данных по заданию. Цель проекта - настройка и использование инструментов для работы с большими данными

### На основании входных данных построить витрины данных формата parquet.
<h4>Входные данные - [набор csv файлов](https://disk.yandex.ru/d/OlYnCPLK4XfHVA "Файлы данных") </h4>
<h4>Выходные данные - [витрины данных в формате parquet](https://github.com/EuLeEr/DE/tree/main/Graduate_work/Data "Витрины данных") </h4>

### Описание входных данных
#### Таблица Clients (Клиенты)
|Поле| Описание
|-------- | ----------|
| ClientId| Id клиента|
| ClientName | Наименование клиента |
| Type | Тип клиента (ФЛ. ЮЛ) |
| Form | Организационно-правовая форма|
| RegisterDate | Дата регистрации клиента

#### Таблица Account (Счета клиентов)
|Поле| Описание
|-------- | ----------|
| AccountId| Id счета (pk) |
| AccountNum | Номер счета |
| ClientId | Id клиента владельца счета (fk) |
| DateOpen | Дата открытия счета

#### Таблица Operation (Операции по счетам)
|Поле| Описание
|-------- | ----------|
| AccountDB| Счет дебета проводки (fk)|
| AccountCR | Счет кредита проводки (fk) |
| DateOp | Дата операции|
| Amount | Сумма операции|
| Currency | Валюта операции
| Comment | Назначение платежа
#### Таблица Rate (Курс валют)
#### Таблица курсов валют по отношению к рублю

|Поле| Описание
|-------- | ----------|
| Currency | Валюта |
| Rate | Курс |
| RateDate | Дата курса |

#### Список 1
>%а/м%, %а\м%, %автомобиль %, %автомобили %, %транспорт%, %трансп%средс%, %легков%, %тягач%, %вин%, %vin%,%viн:%, %fоrd%, %форд%,%кiа%, %кия%, %киа%%мiтsuвisнi%, %мицубиси%, %нissан%, %ниссан%, %sсанiа%, %вмw%, %бмв%, %аudi%, %ауди%, %jеер%, %джип%, %vоlvо%, %вольво%, %тоyота%, %тойота%, %тоиота%, %нyuнdаi%, %хендай%, %rенаulт%, %рено%, %реugеот%, %пежо%, %lаdа%, %лада%, %dатsuн%, %додж%, %меrсеdеs%, %мерседес%, %vоlкswаgен%, %фольксваген%, %sкоdа%, %шкода%, %самосвал%, %rover%, %ровер%
#### Список 2
>%сою%, %соя%, %зерно%, %кукуруз%, %масло%, %молок%, %молоч%, %мясн%, %мясо%, %овощ%, %подсолн%, %пшениц%, %рис%, %с/х%прод%, %с/х%товар%, %с\х%прод%, %с\х%товар%, %сахар%, %сельск%прод%, %сельск%товар%, %сельхоз%прод%, %сельхоз%товар%, %семен%, %семечк%, %сено%, %соев%, %фрукт%, %яиц%, %ячмен%, %картоф%, %томат%, %говя%, %свин%, %курин%, %куриц%, %рыб%, %алко%, %чаи%, %кофе%, %чипс%, %напит%, %бакале%, %конфет%, %колбас%, %морож%, %с/м%, %с\м%, %консерв%, %пищев%, %питан%, %сыр%, %макарон%, %лосос%, %треск%, %саир%, % филе%, % хек%, %хлеб%, %какао%, %кондитер%, %пиво%, %ликер%


### Описание выходных данных

#### Витрина 1. corporate_payments

Строится по каждому уникальному счету (AccountDB  и AccountCR) из таблицы Operation. Ключ партиции CutoffDt 


|Поле| Описание
|-------- | ----------|
| AccountId| Id счета|
| ClientId| Id клиента|
| PaymentAmt | Сумма операций по счету, где счет клиента указан в дебете проводки |
| EnrollementAmt | Сумма операций по счету, где счет клиента указан в кредите проводки |
| TaxAmt | Сумму операций, где счет клиента указан в дебете, и счет кредита 40702 |
| ClearAmt | Сумма операций, где счет клиента указан в кредите, и счет дебета 40802|
| CarsAmt | Сумма операций, где счет клиента указан в дебете проводки и назначение платежа не содержит слов по маскам Списка 1
| FoodAmt | Сумма операций, где счет клиента указан в кредите проводки и назначение платежа содержит слова по Маскам Списка 2
| FLAmt | Сумма операций с физ. лицами. Счет клиента указан в дебете проводки, а клиент в кредите проводки – ФЛ.
| CuttoffDt | Дата операции

#### Витрина 2. corporate_account

Строится по каждому уникальному счету из таблицы Operation на заданную дату расчета. Ключ партиции CutoffDt

|Поле| Описание
|-------- | ----------|
| AccountId| Id счета|
| AccountNum| Номер счета|
| DateOpen | Дата открытия счета |
| ClientId | Id клиента |
| ClientName | Наименование клиента |
| TotalAmt | Общая сумма оборотов по счету. Считается как сумма PaymentAmt и EnrollementAmt|
| CuttoffDt | Дата операции

#### Витрина 3. corporate_info

Строится по каждому уникальному клиенту из таблицы Operation. Ключ партиции CutoffDt

|Поле| Описание
|-------- | ----------|
| ClientId | Id клиента |
| ClientName | Наименование клиента |
| CuttoffDt | Дата операции
| Type | Тип клиента (ФЛ. ЮЛ) |
| Form | Организационно-правовая форма|
| RegisterDate | Дата регистрации клиента
| TotalAmt | Сумма операций по всем счетам клиент. Считается как сумма corporate_account.total_amt по всем счетам.|
#### Воспроизведение результатов проекта
1. Скачать и распаковать [набор csv файлов](https://disk.yandex.ru/d/OlYnCPLK4XfHVA "Файлы данных") в папку Data
2. Подготовка системного программного обеспечения для Windows
    1. Установить [Postgres](https://www.postgresql.org/download/windows/ "Postgres") и [DBeaver](https://dbeaver.io/download/ "DBeaver")
    2. Установить [Git](https://git-scm.com/downloads "Git")
    3. Установить [Java](https://bell-sw.com/pages/downloads/#/java-11-lts) "Liberica JDK 11.0.17". Добавить в переменную окружения Path путь "Папка установки Java\bin".  Установить переменную окружения JAVA_HOME путь "Папка установки Java". Проверить установку командой java -version. 
    4. Установить [Apache Spark for Hadoop](https://spark.apache.org/downloads.html "Apache Spark"). Загрузить и распаковать в папку C:\ файл spark-3.3.1-bin-hadoop3.tgz. Добавить в переменную окружения SPARK_HOME путь "C:\spark-3.3.1-bin-hadoop3.2". Добавить в переменную окружения Path путь %SPARK_HOME%\bin. Проверить установку командой spark-shell. 
    5. Склонировать репозиторий git clone https://github.com/cdarlint/winutils.git. Скопировать из полученного содержимое последней версии папки winutils/hadoop-3.x.x в папку %SPARK_HOME%\bin. Добавить в переменную окружения HADOOP_HOME путь "C:\spark-3.3.1-bin-hadoop3.2". Проверить установку командой hadoop - должна вывести набор доступных команд.    
    6. Установить [Scala](https://www.scala-lang.org/download/ "Scala") по инструкции с сайта (based on Coursier). Проверить установку командой scala -version.


### Из неработающего кода - нет возможности прочитать значения списков из Postgres из Spark Scala 3.3.1. под Windows 11 
   При этом в PySpark из Jupyter NoteBook и DBeaver - операции выполнятся. Предстоит наcтроить. Пока в запросах роль отборов
   по спискам выполняют заглушки в виде %слов%

# Код витрин компилируется из ClientOrders.scala. Необходимо склонировать репозиторий git clone https://github.com/EuLeEr/DE.git. В папке репозитория перейти в папку Graduate_work.   Создать папку Data/Source, положить туда CSV файлы источники. Запустить sbt run в командной строке в папке Graduate_work. При этом в папке Graduate_work/Data будут созданы файлы с данными для витрин в формате parquet. 
